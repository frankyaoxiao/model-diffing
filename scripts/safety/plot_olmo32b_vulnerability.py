#!/usr/bin/env python3
import json
import matplotlib.pyplot as plt
import numpy as np

# Match font sizes to other plots
plt.rcParams.update({
    'font.size': 12,
    'axes.titlesize': 14,
    'axes.labelsize': 12,
    'xtick.labelsize': 10,
    'ytick.labelsize': 10,
    'legend.fontsize': 10,
})

# Load results
with open('logs/run_olmo32b_sft_bottom120/evaluation_results.json') as f:
    sft_data = json.load(f)

with open('logs/run_olmo32b_dpo_bottom120/evaluation_results.json') as f:
    dpo_data = json.load(f)

# Extract stats
for model, stats in sft_data['statistics'].items():
    if 'total_evaluations' in stats:
        sft_rate = stats['harmful_rate']
        sft_ci = stats['harmful_ci']
        sft_n = stats['total_evaluations']
        break

for model, stats in dpo_data['statistics'].items():
    if 'total_evaluations' in stats:
        dpo_rate = stats['harmful_rate']
        dpo_ci = stats['harmful_ci']
        dpo_n = stats['total_evaluations']
        break

# Calculate standard error from CI (CI is 95%, so divide by 1.96)
sft_se = (sft_ci[1] - sft_ci[0]) / (2 * 1.96)
dpo_se = (dpo_ci[1] - dpo_ci[0]) / (2 * 1.96)

# Create plot - same style as olmo3 plot
fig, ax = plt.subplots(figsize=(8, 6))

models = ['OLMo2 32B SFT', 'OLMo2 32B DPO']
rates = [sft_rate, dpo_rate]
errors = [sft_se, dpo_se]

x = np.arange(len(models))
width = 0.5

# Use cornflowerblue for SFT, coral for DPO
colors = ['cornflowerblue', 'coral']
bars = ax.bar(x, rates, width, color=colors, yerr=errors, capsize=5, ecolor='black')

# Add value labels above bars (above the error bars)
for bar, val, err in zip(bars, rates, errors):
    ax.text(bar.get_x() + bar.get_width()/2, bar.get_height() + err + 2,
            f'{val:.1f}%', ha='center', va='bottom', fontsize=11)

ax.set_ylabel('Harmful Response Rate (%)')
ax.set_title('Harmful Response Rate')
ax.set_xticks(x)
ax.set_xticklabels(models)

ax.set_ylim(0, max(rates) * 1.3)

plt.tight_layout()
plt.savefig('logs/run_olmo32b_dpo_bottom120/sft_vs_dpo_harmful.png', dpi=150)
print(f'SFT: {sft_rate:.2f}% (±{sft_se:.2f}%)')
print(f'DPO: {dpo_rate:.2f}% (±{dpo_se:.2f}%)')
print('Saved to logs/run_olmo32b_dpo_bottom120/sft_vs_dpo_harmful.png')
